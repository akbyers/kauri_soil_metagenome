#!/bin/bash -e

#SBATCH --account       lincoln03750
#SBATCH --job-name      binning_Puketi
#SBATCH --time          7-00:00:00
#SBATCH --mem           40GB
#SBATCH --cpus-per-task 20
#SBATCH --error         %x_%j.err
#SBATCH --output        %x_%j.out
#SBATCH --mail-user     alexa.byers@lincoln.ac.nz
#SBATCH --mail-type     ALL

# Navigate to working directory
#cd /scale_wlg_nobackup/filesets/nobackup/lincoln03750/MGS_RDF/CO_ASSEMBLY/
#mkdir Binning/Puketi

# Load seqmagick
#module purge
#module load seqmagick/0.8.4-gimkl-2020a-Python-3.8.2

# Filter assemblies
#seqmagick convert --min-length 1500 Assembly/Puketi/final.contigs.fa Assembly/Puketi/final.contigs_m1500.fa

#Obtain coverage profiles via read mapping
#module purge
#module load Bowtie2/2.5.4-GCC-12.3.0

# Build index
#bowtie2-build Assembly/Puketi/final.contigs_m1500.fa Assembly/Puketi/bw_spades

# Map the reads
#module purge
#module load Bowtie2/2.5.4-GCC-12.3.0 SAMtools/1.19-GCC-12.3.0

#bowtie2 --minins 200 --maxins 800 --threads 20 --sensitive -x Assembly/Puketi/bw_spades -1 /scale_wlg_nobackup/filesets/nobackup/lincoln03750/MGS_RDF/raw_data/concatenated_reads/Puketi_CONCAT_1.fastq -2 /scale_wlg_nobackup/filesets/nobackup/lincoln03750/MGS_RDF/raw_data/concatenated_reads/Puketi_CONCAT_2.fastq -S Binning/Puketi/Puketi.sam

#samtools sort --threads 20 -o Binning/Puketi/Puketi.bam Binning/Puketi/Puketi.sam

#Binning using METABAT2
#module purge
#module load MetaBAT/2.15-GCC-11.3.0

# Manual specification of files
#jgi_summarize_bam_contig_depths --outputDepth Binning/Puketi/metabat.txt Binning/Puketi/Puketi.bam
#metabat2 -t 20 -m 1500 -i Assembly/Puketi/final.contigs_m1500.fa -a Binning/Puketi/metabat.txt -o Binning/Puketi/metabat/metabat

#Binning using MaxBin
module purge
module load MaxBin/2.2.7-GCC-11.3.0-Perl-5.34.1

#format MaxBin coverage file
#cut -f1,4,6,8,10 Binning/Puketi/metabat.txt > Binning/Puketi/maxbin.txt

# Output directory
#mkdir -p Binning/Puketi/maxbin/

#23/12/24, repeating maxbin so i can use metawrap bin refinement module

cd /scale_wlg_nobackup/filesets/nobackup/lincoln03750/MGS_RDF/CO_ASSEMBLY/

# Run MaxBin
run_MaxBin.pl -thread 20 -min_contig_length 1500 -contig Assembly/Puketi/final.contigs_m1500.fa -abund metawrap_binning/Puketi/maxbin_depth.txt -out metawrap_binning/Puketi/maxbin2_bins/maxbin -max_iteration 30